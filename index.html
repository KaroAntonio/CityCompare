<!doctype html>
<html>
<head>

<title>Find Your City</title>
</head>

<body>
<div class="title">Find Your City</div>

<link rel="stylesheet" type="text/css" href="style.css">
<div id="xMenu"></div>
<div id="yMenu"></div>
<div id="zMenu"></div>
<!DOCTYPE html>
<meta charset="utf-8">

<div id="charts"></div>
<div id="container">
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
<script src="http://dimplejs.org/dist/dimple.v2.1.2.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script>

    
var w = window,
    width = w.innerWidth || e.clientWidth || g.clientWidth,
    height = w.innerHeight|| e.clientHeight|| g.clientHeight;
    

var width = 1000,
    height = 1000;

var msvg = d3.select("#container").append("svg")
    .attr("width", width)
    .attr("height", height);

    //Charts are on a seperate svg element
var svg = dimple.newSvg("#charts", 1100, 800); 

//Load All data sets asynchronously in a nested callbacks
d3.tsv("barData.tsv", function (barData) {
d3.tsv("trendData.tsv", function (trendData) {
d3.json("cities.json", function(cities) {
d3.json("alberta.json", function(alberta) {
    
var numBarCharts = Object.keys(barData[0]).length - 1,
    numCities = barData.length,
    barChartWidth = 710/numBarCharts;
    
var barCharts = []; //An Array containing all dimple bar charts
var barXAxes = [];
var chartData;
    
var projection = d3.geo.mercator()
        .scale(1900)
        .translate([width * 8 / 2, height * 5 / 2]);
    
//Reference this Array to determine which cities to draw in the charts
var selected = ["Edmonton", "Calgary"]
var x;

var tip = d3.tip()
  .attr('class', 'd3-tip')
  .offset([-10, 0])
    .html(function(d) {
        //DISPLAY appropriate values
        var city;
        if (d.xValue != null) {
            //Tricky way of determining if 
            //the tooltip is on trend or bar chart
            var isBar = 
                d.seriesShapes[0][0].classList[1] == "dimple-bar";
            if (isBar) {
                city = d.xValue;
            }
            else {
                city = d.seriesValue[0];
            }
        }
        else 
            city = d.properties["marker-symbol"];
        
        var cityData;
        for (var i = 0; i < numCities; i++) {
            if (barData[i].City == city) {
                cityData = barData[i];
            }
        }
        
        return "<span>" + city + "<br>" + 
            "Population: " + cityData.Population + "</span>";
    });

msvg.call(tip);
svg.call(tip); 
    
drawBarCharts();

//MAP
//Alberta
msvg.selectAll("path")
    .data(alberta.features)
    .enter()
    .append("path")
    .attr("z-index", -1)
    .attr("fill", "#dfdfdf")
    .attr("d", d3.geo.path().projection(projection));

//Cities
msvg.selectAll("circle")
   .data(cities.features)
   .enter()
   .append("circle")
   .attr("cx", function(d) {
           return projection([
               d.geometry.coordinates[0],
               d.geometry.coordinates[1]
               ])[0];
   })
   .attr("cy", function(d) {
       return projection([
           d.geometry.coordinates[0],
           d.geometry.coordinates[1]
       ])[1];
   }) 
   .attr("r", 6)
   .style("fill", initColor)
    .style("stroke", "#fff")
    .style("stroke-width", 2)
   .style("opacity", 0.75)
    .on("mouseover", function(d) {
        tip.show(d);
        d3.select(this).attr("r", 10);
        d3.select(this).style("opacity", 0.95);
        })
    .on("mouseout", function(d) {
        tip.hide(d);
        d3.select(this).attr("r", 6);
        d3.select(this).style("opacity", 0.75);
    })
    .on("click", function(d) {
        toggle(d, this);
    });


//BAR CHARTS
function drawBarCharts() {
    for (var i = 0; i < numBarCharts; i++) {
        chartData = dimple.filterData(barData, "City", selected);
        var chart = new dimple.chart(svg, chartData);
        chart.setBounds(((barChartWidth + 60) * i) + 60, 30, barChartWidth, 300);
        var xAxis = chart.addCategoryAxis("x", "City");
        var yAxis = 
            chart.addMeasureAxis("y", Object.keys(barData[0])[i+1]);
        var bars = chart.addSeries("City", dimple.plot.bar);
        //COLOR by City
        setChartColors(chart);
        xAxis.title = "";
        bars.addEventHandler("mouseover", tip.show);
        bars.addEventHandler("mouseout", tip.hide);
        chart.draw();
        xAxis.shapes.selectAll("text").remove(); 
        barCharts.push(chart);
        barXAxes.push(xAxis);
    }
    
}

//TREND CHART
chartData = dimple.filterData(trendData, "City", selected);
var trendChart = new dimple.chart(svg, chartData);
trendChart.setBounds(60, 380, 705, 305);
var x = trendChart.addCategoryAxis("x", "Month");
x.addOrderRule("Date",true);
trendChart.addMeasureAxis("y", "Rental Rate");
var trends = trendChart.addSeries("City", dimple.plot.line);
//COLOR by City
setChartColors(trendChart);
trends.addEventHandler("mouseover", tip.show);
trends.addEventHandler("mouseout", tip.hide);
trendChart.draw();
    
function toggle(d, c) {
    //CHECK if city is selected
    var cityName = d.properties["marker-symbol"];
    var index = selected.indexOf(cityName);
    
    //TOGGLE Selection
    if (index == -1) {
        selected.push(cityName);
        d3.select(c).style("fill", cityColor(cityName));
    }
    else {
        selected.splice(index, 1);
        d3.select(c).style("fill", "#777");
    }
    
    //Filter Charts
    for (var i = 0; i < barCharts.length; i++) {
        barCharts[i].data = dimple.filterData(barData, "City", selected);
        barCharts[i].draw(300);
        barXAxes[i].shapes.selectAll("text").remove(); 
    }
}
    
function initColor(d) {
    city = d.properties["marker-symbol"];
    var isSelected = selected.indexOf(city) != -1;
    
    if (isSelected) 
        return cityColor(city);
    else 
        return "#777";
}
    
function cityColor(city) {
    //Return City Specific colors
    if (city == "Edmonton") return "#E085C2";
    if (city == "Calgary") return "#FFE0A3";
    if (city == "Red Deer") return "#FEFEC1";
    if (city == "Lethbridge") return "#FF9494";
    if (city == "Fort McMurray") return "#CCB2FF";
    if (city == "Canmore") return "#C2DF83";
    if (city == "St. Albert") return "#99CCB2";
}
    
function setChartColors(chart) {
    for (var i = 0; i < numCities; i++ ) {
        var cityName = barData[i].City;
        chart.assignColor(cityName, cityColor(cityName), cityColor(cityName), 0.7);
    }
}

});
});
});   
});

</script>
</div>
</body>
</html>