<!doctype html>
<html>
<head>

<title>Find Your City</title>
</head>

<body>
<div class="title">Find Your City</div>

<link rel="stylesheet" type="text/css" href="style.css">
<div id="xMenu"></div>
<div id="yMenu"></div>
<div id="zMenu"></div>
<!DOCTYPE html>
<meta charset="utf-8">

<div id="charts"></div>
<div id="container">
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
<script src="http://dimplejs.org/dist/dimple.v2.1.2.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script>

    /*
var w = window,
    width = w.innerWidth || e.clientWidth || g.clientWidth,
    height = w.innerHeight|| e.clientHeight|| g.clientHeight;
    */
    
var width = 1000,
    height = 1000;

var msvg = d3.select("#container").append("svg")
    .attr("width", width)
    .attr("height", height);

    //Charts are on a seperate svg element
var svg = dimple.newSvg("#charts", 900, 800); 

//Load All data sets asynchronously in a nested callbacks
d3.tsv("singularData.tsv", function (barData) {
d3.tsv("example_data.tsv", function (trendData) {

var numBarCharts = Object.keys(barData[0]).length - 1;
    barChartWidth = 710/numBarCharts
    
var barCharts = []; //An Array containing all dimple bar charts
var chartData;
    
var projection = d3.geo.mercator()
        .scale(1900)
        .translate([width * 8 / 2, height * 5 / 2]);
    
//Reference this Array to determine which cities to draw in the charts
var selected = []
var x;

var tip = d3.tip()
  .attr('class', 'd3-tip')
  .offset([-10, 0])
  .html(function(d) {
      //DISPLAY appropriate values
      var city;
        if (d.xValue != null) {
            //Tricky way of determining if 
            //the tooltip is on trend or bar chart
            var isBar = 
                d.seriesShapes[0][0].classList[1] == "dimple-bar";
            console.log(isBar);
            if (isBar) {
                city = d.xValue;
            }
            else {
                city = d.seriesValue[0];
            }
        }
        else 
          city = d.properties["marker-symbol"];
      
        return "<span>City<span><br>"+city+ "</span>";
  });

msvg.call(tip);
svg.call(tip); 
    
drawBarCharts();

//MAP
d3.json("alberta.json", function(error, alberta) {
    if (error) return console.error(error);

    msvg.selectAll("path")
           .data(alberta.features)
           .enter()
           .append("path")
           .attr("d", d3.geo.path().projection(projection));
    x = 5;
});

d3.json("cities.json", function(error, cities) {
    if (error) return console.error(error);

    msvg.selectAll("circle")
       .data(cities.features)
       .enter()
       .append("circle")
       .attr("cx", function(d) {
               return projection([
                   d.geometry.coordinates[0],
                   d.geometry.coordinates[1]
                   ])[0];
       })
       .attr("cy", function(d) {
           return projection([
               d.geometry.coordinates[0],
               d.geometry.coordinates[1]
           ])[1];
       }) 
       .attr("r", 5)
       .style("fill", "white")
       .style("opacity", 0.75)
        .on("mouseover", function(d) {
            d3.select(this).attr("r", 10);
            d3.select(this).style("opacity", 0.95);
            })
        .on("mouseout", function(d) {
            d3.select(this).attr("r", 5);
            d3.select(this).style("opacity", 0.75);
        })
        .on('mouseover', tip.show)
        .on('mouseout', tip.hide)
        .on("click", function(d) {
            toggle(d, this);
        });
});

//BAR CHARTS
function drawBarCharts() {
    for (var i = 0; i < numBarCharts; i++) {
        chartData = dimple.filterData(barData, "City", selected);
        var chart = new dimple.chart(svg, chartData);
        chart.setBounds(((barChartWidth + 60) * i) + 60, 30, barChartWidth, 300);
        var xAxis = chart.addCategoryAxis("x", "City");
        var yAxis = 
            chart.addMeasureAxis("y", Object.keys(barData[0])[i+1]);
        var bars = chart.addSeries(null, dimple.plot.bar);
        xAxis.title = "";
        bars.addEventHandler("mouseover", tip.show);
        bars.addEventHandler("mouseout", tip.hide);
        chart.draw();
        xAxis.shapes.selectAll("text").remove(); 
        barCharts.push(chart);
    }
    
}

//TREND CHART
chartData = dimple.filterData(trendData, "Owner", ["Aperture", "Black Mesa"])
var trendChart = new dimple.chart(svg, chartData);
trendChart.setBounds(60, 380, 705, 305);
var x = trendChart.addCategoryAxis("x", "Month");
x.addOrderRule("Date");
trendChart.addMeasureAxis("y", "Unit Sales");
var trends = trendChart.addSeries("Channel", dimple.plot.line);
trends.addEventHandler("mouseover", tip.show);
trends.addEventHandler("mouseout", tip.hide);
trendChart.draw();
    
function toggle(d, c) {
    //CHECK if city is selected
    var cityName = d.properties["marker-symbol"];
    var index = selected.indexOf(cityName);
    
    //TOGGLE Selection
    if (index == -1) {
        selected.push(cityName);
        d3.select(c).style("fill", "orange");
    }
    else {
        selected.splice(index, 1);
        d3.select(c).style("fill", "white");
    }
    
    //Filter Charts
    for (var i = 0; i < barCharts.length; i++) {
        barCharts[i].data = dimple.filterData(barData, "City", selected);
        barCharts[i].draw();
    }
}

});   
});

</script>
</div>
</body>
</html>