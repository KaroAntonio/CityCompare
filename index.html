<!doctype html>
<meta charset="utf-8">
<html>
<head>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
<script src="http://dimplejs.org/dist/dimple.v2.1.2.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<title>Live Alberta</title>
<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
<div class="title">Live Alberta</div>

<div id="barMenu1"></div>
<div id="barMenu2"></div>
<div id="barMenu3"></div> 
<div id="barMenu4"></div>
<div id="trendMenu1"></div> 
<div id="charts"></div>
<div id="container">
<script>

var w = window,
    width = w.innerWidth || e.clientWidth || g.clientWidth,
    height = w.innerHeight|| e.clientHeight|| g.clientHeight;
    
var width = 1000,
    height = 1000,
    chartWidth = width * 0.6
    legendOffset = width * 0.054;

var msvg = d3.select("#container").append("svg")
    .attr("width", width)
    .attr("height", height);

//Charts are on a seperate svg element
var svg = dimple.newSvg("#charts", 1100, 800); 

//Load All data sets asynchronously in a nested callbacks
d3.tsv("barData.tsv", function (barData) {
d3.tsv("trendData.tsv", function (trendData) {
d3.json("cities.json", function(cities) {
d3.json("alberta.json", function(alberta) {
    
//FORMAT Trend Data
var format = d3.time.format("%y-%b");

for (var i = 0; i < trendData.length; i++) {
    trendData[i].Month = format.parse(trendData[i].Month);
}

var selectedTrendCharts = [
    Object.keys(trendData[0])[2]],
    selectedBarCharts = [
    Object.keys(barData[0])[1],
    Object.keys(barData[0])[2],
    Object.keys(barData[0])[3],
    Object.keys(barData[0])[4]];
var numBarCharts = selectedBarCharts.length,
    numCities = barData.length,
    trendChartTypes = Object.keys(trendData[0]).slice(2, Object.keys(trendData[0]).length),
    barChartTypes = 
    Object.keys(barData[0]).slice(1, Object.keys(barData[0]).length);
    barChartWidth = chartWidth/numBarCharts;

var trendChart;
var barCharts = []; //An Array containing all dimple bar charts
var barXAxes = [];
var chartData;

var trendValue = "Rental Rate";
    
var legendBox,
    legendTitle,
    legendCircles,
    legendCities,
    toggleTitle,
    trendTitle,
    barTitle;
    
var projection = d3.geo.mercator()
        .scale(1900)
        .translate([width * 8 / 2, height * 5 / 2]);
    
//Reference this Array to determine which cities to draw in the charts
var selectedCities = ["Edmonton", "Calgary"]
var x;

//Initialize Tool Tip
var tip = d3.tip()
    .direction(function(d) {
        if (Object.keys(d).length == 3) return 'e';
        else return 'w';
    }) 
    .offset(function(d) {
        if (Object.keys(d).length == 3) return [0,10];
        else return [0,-10];
    })
    .attr('class', 'd3-tip')
    .html(function(d) {
        //DISPLAY appropriate values
        var city;
        if (d.xValue != null) {
            //Tricky way of determining if 
            //the tooltip is on trend or bar chart
            var isBar = 
                d.seriesShapes[0][0].classList[1] == "dimple-bar";
            if (isBar) {
                city = d.xValue;
            }
            else {
                city = d.seriesValue[0];
            }
        }
        else 
            city = d.properties["marker-symbol"];
        
        var cityData;
        for (var i = 0; i < numCities; i++) {
            if (barData[i].City == city) {
                cityData = barData[i];
            }
        }
        
        var content = "<span><strong>" + city + "</strong>";
        for (var i = 1; 
             i < Object.keys(barData[0]).length; 
             i++) {
            var key = Object.keys(barData[0])[i];
            var value = cityData[Object.keys(barData[0])[i]]
            if ((selectedCities.indexOf(city) == -1) ||
               (value != "") &&
               (selectedBarCharts.indexOf(key) == -1))
                content += "<br>" + key + ": " + value;
        }
        content += "<span>";
        
        return content;
    });

msvg.call(tip);
svg.call(tip); 
    
//Draw All Elements
drawBarCharts();
drawTrendChart();
drawChartMenus();
drawMap();
drawLegend();

function drawChartMenus() {
    
    var barMenu1 = d3.select("#barMenu1")
            .style("top", height/2 -4 + "px")
            .append("select")
            .on("change", function() {
                //SET new Value
                selectedBarCharts[0] = 
                    this.options[this.selectedIndex].__data__;
                
                //Draw Bar Charts
                UpdateCharts();
            })
            .selectAll("option")
            .data(barChartTypes)
            .enter()
            .append("option")
            .attr("value", function (d) {
                return d;
            })
            .text(function (d) {
                return d;
            })
            .property("selected", function(d){ return d === selectedBarCharts[0]; });

    var barMenu2 = d3.select("#barMenu2")
            .style("top", height/2 + 20 + "px")
            .append("select")
            .on("change", function() {
                //SET new Value
                selectedBarCharts[1] = 
                    this.options[this.selectedIndex].__data__;

                //Draw Bar Charts
                UpdateCharts();
            })
            .selectAll("option")
            .data(barChartTypes)
            .enter()
            .append("option")
            .attr("value", function (d) {
                return d;
            })
            .text(function (d) {
                return d;
            })
            .property("selected", function(d){ return d === selectedBarCharts[1]; });

    var barMenu3 = d3.select("#barMenu3")
            .style("top", height/2 + 44 + "px")
            .append("select")
            .on("change", function() {
                //SET new Value
                selectedBarCharts[2] = 
                    this.options[this.selectedIndex].__data__;

                //Draw Bar Charts
                UpdateCharts();
            })
            .selectAll("option")
            .data(barChartTypes)
            .enter()
            .append("option")
            .attr("value", function (d) {
                return d;
            })
            .text(function (d) {
                return d;
            })
            .property("selected", function(d){ return d === selectedBarCharts[2]; });
    
    var barMenu4 = d3.select("#barMenu4")
            .style("top", height/2 + 68 + "px")
            .append("select")
            .on("change", function() {
                //SET new Value
                selectedBarCharts[3] = 
                    this.options[this.selectedIndex].__data__;

                //Draw Bar Charts
                UpdateCharts();
            })
            .selectAll("option")
            .data(barChartTypes)
            .enter()
            .append("option")
            .attr("value", function (d) {
                return d;
            })
            .text(function (d) {
                return d;
            })
            .property("selected", function(d){ return d === selectedBarCharts[3]; });
    
    var trendMenu1 = d3.select("#trendMenu1")
            .style("top", height/2 + 120 + "px")
            .append("select")
            .on("change", function() {
                //SET new Value
                selectedTrendCharts[0] = 
                    this.options[this.selectedIndex].__data__;

                //Draw Bar Charts
                UpdateCharts();
            })
            .selectAll("option")
            .data(trendChartTypes)
            .enter()
            .append("option")
            .attr("value", function (d) {
                return d;
            })
            .text(function (d) {
                return d;
            })
            .property("selected", function(d){ return d === selectedTrendCharts[0]; });
}

//MAP
//Alberta
function drawMap() {
    msvg.selectAll("path")
    .data(alberta.features)
    .enter()
    .append("path")
    .attr("z-index", -1)
    .attr("fill", "#dfdfdf")
    .attr("d", d3.geo.path().projection(projection));

//Cities
msvg.selectAll("circle")
   .data(cities.features)
   .enter()
   .append("circle")
   .attr("cx", function(d) {
           return projection([
               d.geometry.coordinates[0],
               d.geometry.coordinates[1]
               ])[0];
   })
   .attr("cy", function(d) {
    console.log(d);
       return projection([
           d.geometry.coordinates[0],
           d.geometry.coordinates[1]
       ])[1];
   }) 
   .attr("r", 7)
   .style("fill", initColor)
    .style("stroke", "#fff")
    .style("stroke-width", 2)
   .style("opacity", 0.75)
    .on("mouseover", function(d) {
        
        tip.show(d);
        d3.select(this).attr("r", 10);
        d3.select(this).style("opacity", 0.95);
        })
    .on("mouseout", function(d) {
        tip.hide(d);
        d3.select(this).attr("r", 6);
        d3.select(this).style("opacity", 0.75);
    })
    .on("click", function(d) {
        toggleCity(d, this);
    });
}

function drawLegend() {
    //Cities Legend
    if (legendBox != null)
        legendBox.remove();
    
    legendBox = msvg.append("rect")
                .attr("fill", "#aaa")
                .attr("x", legendOffset * 0.7)
                .attr("y", height * 0.016)
                .attr("width", 180)
                .attr("height", 33 + (selectedCities.length * 22))
                .style("z-index", 10);
    
    if (legendTitle != null)
        legendTitle.remove();
    
    legendTitle = msvg.append("g")
            .attr("width", 200)
            .attr("height", 50)
            .selectAll("text")
            .data(["Selected Cities"])
            .enter()
            .append("text")
            .attr("x", legendOffset)
            .attr("y", height * 0.04)
            .attr("fill", "#fff")
            .attr('class', 'legendTitle')
            .text(function (d) { return d; });
    
    if (legendCircles != null)
        legendCircles.remove();
    
    legendCircles = msvg.append("g")
                    .selectAll("circle")
                    .data(selectedCities)
                    .enter()
                    .append("circle")
                    .attr("fill", cityColor)
                    .attr("opacity", 0.9)
                    .attr("r", 8)
                    .attr("stroke", "#fff")
                    .attr("stroke-width", "2px")
                    .attr("cx", legendOffset + 10)
                    .attr("cy", function (d,i) { 
                        return (height*0.06 - 6 + (i * 22)); })
                    .attr("width", 200)
                    .style("z-index", 10)
                    .on("click", function(d) {
                        toggleCity(d, this);
                            });
    
    if (legendCities != null)
        legendCities.remove();
    
    legendCities = msvg.append("g")
                .attr("width", 200)
                .attr("height", 50 * selectedCities.length)
                .selectAll("text")
                .data(selectedCities)
                .enter()
                .append("text")
                .attr("fill", "#fff")
                .attr("x", legendOffset + 30)
                .attr("y", function (d,i) { 
                    return (height*0.06 + (i * 22)); })
                .attr('class', 'legend')
                .text(function (d) { return d; });
    
    if (toggleTitle != null)
        toggleTitle.remove();
    toggleTitle = svg.append("g")
                .attr("width", 200)
                .attr("height", 50)
                .selectAll("text")
                .data(["Toggle Charts"])
                .enter()
                .append("text")
                .attr("x", width * 0.748)
                .attr("y", height * 0.38)
                .attr('class', 'legendTitle')
                .text(function (d) { return d; });
    
    if (barTitle != null)
        barTitle.remove();
    barTitle = svg.append("g")
                .attr("width", 200)
                .attr("height", 50)
                .selectAll("text")
                .data(["Bar"])
                .enter()
                .append("text")
                .attr("x", width * 0.77)
                .attr("y", height * 0.406)
                .attr('class', 'legend')
                .text(function (d) { return d; });
    
    if (trendTitle != null)
        trendTitle.remove();
    trendTitle = svg.append("g")
                .attr("width", 200)
                .attr("height", 50)
                .selectAll("text")
                .data(["Trend"])
                .enter()
                .append("text")
                .attr("x", width * 0.77)
                .attr("y", height * 0.528)
                .attr('class', 'legend')
                .text(function (d) { return d; });
}

//BAR CHARTS
function drawBarCharts() {
    barCharts = [];
    barChartWidth = chartWidth*1.4/numBarCharts - 20;
    barXAxes = [];
    for (var i = 0; i < numBarCharts; i++) {
        chartData = filterBarData(selectedBarCharts[i]);
        var chart = new dimple.chart(svg, chartData);
        chart.setBounds(((barChartWidth + 60) * i) + 60, 30, barChartWidth, 300);
        var xAxis = chart.addCategoryAxis("x", "City");
        var yAxis = 
            chart.addMeasureAxis("y", selectedBarCharts[i]);
        var bars = chart.addSeries("City", dimple.plot.bar);
        //COLOR by City
        setChartColors(chart);
        xAxis.title = "";
        bars.addEventHandler("mouseover", tip.show);
        bars.addEventHandler("mouseout", tip.hide);
        chart.draw(300);
        xAxis.shapes.selectAll("text").remove(); 
        barCharts.push(chart);
        barXAxes.push(xAxis);
    }
    
}

//TREND CHART
function drawTrendChart() {
    chartData = dimple.filterData(trendData, "City", selectedCities);
    trendChart = new dimple.chart(svg, chartData);
    trendChart.setBounds(60, height * 0.36, chartWidth * 1.06, 305);
    var x = trendChart.addTimeAxis("x", "Month");
    x.tickFormat = "%y-%b";
    x.addOrderRule("Date");
    trendChart.addMeasureAxis("y", trendValue);
    var trends = trendChart.addSeries("City", dimple.plot.line);
    //COLOR by City
    setChartColors(trendChart);
    trends.addEventHandler("mouseover", tip.show);
    trends.addEventHandler("mouseout", tip.hide);
    trendChart.draw(300);
}

    
function toggleCity(d, c) {
    //CHECK if city is selected
    var cityName = d.properties["marker-symbol"];
    var index = selectedCities.indexOf(cityName);
    
    //TOGGLE Selection
    if (index == -1) {
        selectedCities.push(cityName);
        d3.select(c).style("fill", cityColor(cityName));
    }
    else {
        selectedCities.splice(index, 1);
        d3.select(c).style("fill", "#777");
    }
    
    drawLegend();
    
    //Filter Charts
    for (var i = 0; i < numBarCharts; i++) {
        barCharts[i].data = filterBarData(selectedBarCharts[i]);
        barCharts[i].draw(300);
        barXAxes[i].shapes.selectAll("text").remove(); 
    }
    
    trendChart.data = 
            dimple.filterData(trendData, "City", selectedCities);
    trendChart.draw(300);
}
    
function UpdateCharts() {
    svg.selectAll("*").remove();
    drawLegend();
    drawBarCharts();
    drawTrendChart();
}
    
function filterBarData(yValue) {
    
    data = dimple.filterData(barData, "City", selectedCities);
    
    var filteredData = [];
    for(var j = 0; j < data.length; j++) {
        var value = data[j]["" + yValue];
        if (value != "")
            filteredData.push(data[j]);
    }
    
    return filteredData;
}
    
function initColor(d) {
    city = d.properties["marker-symbol"];
    var isSelected = selectedCities.indexOf(city) != -1;
    
    if (isSelected) 
        return cityColor(city);
    else 
        return "#777";
}
    
function cityColor(city) {
    //Return City Specific colors
    if (city == "Edmonton") return "#CC3399";
    if (city == "Calgary") return "#FFCC66";
    if (city == "Red Deer") return "#FDFD63";
    if (city == "Lethbridge") return "#FF6666";
    if (city == "Wood Buffalo") return "#9966FF";
    if (city == "Canmore") return "#99C930";
    if (city == "St. Albert") return "#339966";
    if (city == "Grande Prairie") return "#4775FF";
    if (city == "Medicine Hat") return "#FF85FF";
    
}
    
function setChartColors(chart) {
    for (var i = 0; i < numCities; i++ ) {
        var cityName = barData[i].City;
        chart.assignColor(cityName, cityColor(cityName), cityColor(cityName), 0.7);
    }
}

});
});
});   
});

</script>
</div>
</body>
</html>